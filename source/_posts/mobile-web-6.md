title: 移动Web开发--离线缓存
date: 2014-02-25 19:41:12
categories: [移动开发]
tags: [html5]
---

移动用户访问应用的时候，网络都是在不稳定状态，又或者随着移动用户所在的信号问题，导致网络中断。离线缓存可以有效缓解网络中断后，用户无法正常使用web应用的问题。

离线缓存
------------------------

###如何使用离线缓存

* **创建一个名为"manifest.appcache"文件**。

```sh
CACHE MANIFEST
//列出所有想要做缓存的文件，不需要指定离线缓存页面本身

#version 1 //这个manifest的版本号
http://i.thsi.cn/images/ifund/mobile/srdz/rate-bg.png
http://s.thsi.cn/js/ifund/mobile/zepto.min.js

NETWORK:
//列出所有不需要做缓存的文件的URL，这些文件只有当客户端与服务器端建立连接才能访问

FALLBACK:
//每一行指定两个资源文件，第一个文件为在线访问时使用的资源文件，第二个文件为不能在线访问时的替代资源文件
```
<!--more-->

* **将要做离线缓存的html页面中的`<html>`标签，改成`<html manifest="manifest.appcache">`**。

在移动客户端非首次访问这个页面，断掉网络，页面还会正常加载，并能正常交互。

###浏览器与服务器的交互

**在地址栏中输入url后**

 1. 服务端返回url页面资源，浏览器载入html。
 2. 浏览器开始解析。
 3. 发现link，发送请求载入css文件。
 4. 浏览器渲染页面。
 5. 发现图片，发送请求载入图片。
 6. 发送请求js文件，阻塞渲染。如果js对dom进行了操作，则会进行rerender。

**对于支持离线缓存的页面，浏览器和服务器的交互会如下：**

首次载入页面：
 1-6. 同上。
 7、 请求页面中需要缓存的页面和数据，就算在之前的步骤中已经请求过（这是个耗能的地方）
 8、 服务器返回所有请求文件，浏览器解析页面时，解读manifest属性，加载缓存文件(大概是5MB的空间)


再次载入页面：

 1. 发送请求
 2. 使用应用缓存的离线文件
 3. 解析页面
 4. 随后会请求服务端的manifest文件（联网状态下），判断是否有改变。返回304则表示没有改变，通知浏览器manifest没有更新，执行再次载入页面步骤6（下面）。如发现更新，则处理manifest文件，执行再次载入页面步骤5。
 5. 进入首次载入页面的7-8，并触发一个事件，通知应用缓存已被更新。
 6. 使用应用缓存，不重新请求

注：**即使资源文件被修改过，但是页面不会立马使用新的资源文件**，只有重新打开这个页面的时候才能使用更新过后的资源文件。

但是，我在实际应用中遇到一个问题，就是无论我怎么刷新都是按旧的资源文件渲染，我一下子从惊喜掉进恐慌，更新不了，那我修改内容会很囧。

###如何更新离线缓存

想要更新资源，常见的办法就是修改manifest文件头部版本号

通过ApplicationCache对象接口，动态更新缓存：

```sh
//第二次载入，如果manifest被更新，在下载结束时候触发
var appCache = window.applicationCache;
appCache.onupdateready = function(){
   applicationCache.swapCache();
   location.reload();
}
```
swapCache()方法被调用，浏览器用户代理会执行以下步骤：
1. 检查ApplicationCache对象的缓存主机都与一个应用程序缓存相关联。若否，则抛出一个InvalidStateError异常并跳过下面步骤。
2. 让缓存成为该ApplicationCache对象的缓存主机相关联的应用程序缓存。
3. 如果缓存的应用程序缓存组被标记为过时，那么取消ApplicationCache对象的缓存主机和应用程序缓存关联并跳过下面步骤。 （资源现在从网络而不是高速缓存中加载。）
4. 检查是否有在同一个应用程序缓存组中，标志是完整的、比缓存更新的应用程序缓存。如果没有，则抛出一个InvalidStateError异常并跳过下面步骤。
5. 让标志是完整的新的缓存在同一个应用程序缓存组作为最新的应用程序缓存。
6. 取消原有缓存和ApplicationCache对象的缓存主机的关联，并用新缓存代替关联。

###离线缓存的局限

1. hz/?newcode=2011081194和hz/?newcode=2011100312被存储成了两个html不同的页面，想想当用户浏览了多个不同页面，浏览器就缓存了多个没有意义的页面。
2. 进行离线储存时会再次下载一次对应的数据，意思就是说，第一次访问时，使用了离线储存技术的页面加载时所消耗的时间比没有使用这个技术的页面要多，而且耗的流量更大。

因此，离线缓存不适合含有动态参数页面跳转的情况下使用。

