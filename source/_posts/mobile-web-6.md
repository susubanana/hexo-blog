title: 移动Web开发--离线存储
date: 2014-02-25 19:41:12
categories: [移动开发]
tags: [html5]
---

移动用户访问应用的时候，网络都是在不稳定状态，又或者随着移动用户所在的信号问题，导致网络中断。离线存储可以有效缓解网络中断后，用户无法正常使用web应用的问题。

离线存储
------------------------

###如何使用离线存储

首先，**创建一个名为"manifest.appcache"文件**。

```sh
CACHE MANIFEST

#version 1 //这个manifest的版本号
http://i.thsi.cn/images/ifund/mobile/srdz/rate-bg.png
http://s.thsi.cn/js/ifund/mobile/zepto.min.js

NETWORK:

FALLBACK:

```

在`CACHE MANIFEST`语句下面，列出所有想要做缓存的文件，为某个页面做本地存储时，不需要指定页面本身，浏览器会自动对这个页面进行本地存储。
<!--more-->

在`NETWORK`语句下面，列出所有不需要做缓存的文件的URL，这些文件只有当客户端与服务器端建立连接才能访问。

在`FALLBACK`语句下面，每一行指定两个资源文件，第一个文件为能够在线访问时使用的资源文件，第二个文件为不能在线访问时的替代资源文件。。

然后，**将要做离线缓存的html页面中的`<html>`标签，改成`<html manifest="manifest.appcache">`**。

在移动客户端非首次访问这个页面，断掉网络，页面还会正常加载，并能正常交互。

###浏览器与服务器的交互

**在地址栏中输入url后发生了什么？**

 1. 服务端返回url页面资源，浏览器载入html。
 2. 浏览器开始解析。
 3. 发现link，发送请求载入css文件。
 4. 浏览器渲染页面。
 5. 发现图片，发送请求载入图片。
 6. 发送请求js文件，阻塞渲染。如果js对dom进行了操作，则会进行rerender。

**对于支持离线存储的页面，浏览器和服务器的交互又是如何呢？**

首次载入页面：
 1-6. 同上。
 7、 请求页面中需要缓存的页面和数据，就算在之前的步骤中已经请求过（这是个耗能的地方）
 8、 服务器返回所有请求文件，浏览器进行本地存储


再次载入页面：

 1. 发送请求
 2. 使用本地存储的离线文件
 3. 解析页面
 4. 请求服务端的manifest文件，判断是否有改变。返回304则表示没有改变，通知浏览器manifest没有更新，执行再次载入页面步骤6（下面）。如发现更新，则处理manifest文件，执行再次载入页面步骤5。
 5. 进入首次载入页面的7-8，并触发一个事件，通知本地存储已被更新。
 6. 使用本地存储，不重新请求

注：**即使资源文件被修改过，但是页面不会立马使用新的资源文件**，只有重新打开这个页面的时候才能使用更新过后的资源文件。

但是，我在实际应用中遇到一个问题，就是无论我怎么刷新都是按旧的资源文件渲染，我一下子从惊喜掉进恐慌，更新不了，那我修改内容会很囧。